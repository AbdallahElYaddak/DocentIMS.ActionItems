<html xmlns="http://www.w3.org/1999/xhtml"
  xmlns:metal="http://xml.zope.org/namespaces/metal"
  xmlns:tal="http://xml.zope.org/namespaces/tal"
  xmlns:i18n="http://xml.zope.org/namespaces/i18n" i18n:domain="DocentIMS.ActionItems" metal:use-macro="context/main_template/macros/master">
  <body>
    <metal:content-core fill-slot="content">
      <metal:block define-macro="content">


        <style>
        table { border-collapse: collapse; width: 100%; }
        tr:nth-child(even) {background: white} 
        th, td { border: 1px solid #ddd; padding: 6px; text-align: center; }
        th:first-child, td:first-child { text-align: left; }
        th { background-color: #f2f2f2; }
        .yes { color: green; xfont-weight: bold; }
        .no { color: red; }
        .margin-10-0 {margin: 10px 0;}
        </style>


        <h1>Permission & Workflow Audit</h1>

        <form method="get">
          <label>User IDs:</label>
          <br />

          <input id="users" name="users" class="pat-select2 margin-10-0" value="${view/request/users|None}" type="hidden" data-pat-select2='{
                  "placeholder": "Search for users",
                  "width": "40em",
                  "separator": ",",
                  "vocabularyUrl": "${view/portal_url}/@@getVocabulary?name=plone.app.vocabularies.Users"}' />



          <!-- <input id="users" name="users" class="pat-select2 margin-10-0" tal:define="users request/users|None" value="${users}" type="hidden" data-pat-select2='{
                  "placeholder": "Search for users",
                  "width": "40em",
                  "separator": ",",
                  "vocabularyUrl": "${view/portal_url}/@@getVocabulary?name=plone.app.vocabularies.Users"}' /> -->

          <br />
          <label>Path to audit (e.g. Documents):</label>
          <br />

          <select id="folder" name="folder" class="pat-select2" data-pat-select2="width:20em;">
            <option value=""></option>
            <option tal:repeat="folder view/get_folders" tal:attributes="selected python: folder['uid'] == request.get('folder')" value="${folder/uid}">
                ${folder/text}
            </option>
          </select>

          <br />
          <input type="submit" class="btn btn-primary margin-10-0" value="Run Audit"/>
        </form>
        <p></p>

        <tal:block tal:condition="view/get_results|None">

          <table tal:define="results view/get_results|None">
            <thead>
              <tr>
                <th>Content Item</th>
                <!-- <th>Path</th>                 -->
                <th>View</th>
                <th>Modify</th>
                <th>Delete</th>
                <th>Workflow<br/>
Actions</th>
                <th>Other Permissions</th>
              </tr>
            </thead>
            <tbody>
              <tal:loop tal:repeat="row results">
                <tr>
                  <td>
                     ${row/title}<br/>
                  <a href="${row/url|None}">${row/url|None}</a>
                </td>
                <tal:define tal:define="users view/get_users">
                  <td>
                    <tal:block tal:repeat="user users">
                      <p tal:define="perms row/users; user python:user" tal:attributes="class python:'yes' if perms and perms[user]['View'] else 'no'">
                          ${python: perms[user]['name']} <span tal:content="python:'✔' if perms and perms[user]['View'] else '✘'" />
                      </p>

                    </tal:block>
                  </td>
                  <td>
                    <tal:block tal:repeat="user users">
                      <p tal:define="perms row/users; user python:user" tal:attributes="class python:'yes' if perms and perms[user]['Modify'] else 'no'">
                          ${python: perms[user]['name']} <span tal:content="python:'✔' if perms and perms[user]['Modify'] else '✘'" />
                      </p>
                    </tal:block>
                  </td>
                  <td>
                    <tal:block tal:repeat="user users">
                      <p tal:define="perms row/users; user python:user" tal:attributes="class python:'yes' if perms and perms[user]['Delete'] else 'no'">
                          ${python: perms[user]['name']} <span tal:content="python:'✔' if perms and perms[user]['Delete'] else '✘'" />
                      </p>
                    </tal:block>
                    <td>
                      <tal:block tal:repeat="user users">
                        <p tal:define="perms row/users; user python:user">
                          <tal:cond tal:condition="perms">
                          ${python: perms[user]['name']}<br/>
                          <span tal:repeat="action python: perms[user]['workflow_actions']" class="action">

                            <b>[${action/title}]</b>
                          </span>
                        </tal:cond>
                      </p>
                    </tal:block>
                  </td>
                  <td>
                    <tal:block tal:repeat="user users">
                      <div tal:define="perms row/users; user python:user">
                        <p>
                          <a href="#user-${repeat/user/index}" class="plone-btn plone-btn-large plone-btn-primary pat-plone-modal">${python: perms[user]['name']}</a>
                        </p>
                        <div id="user-${repeat/user/index}" style="display: none">
                        <h6>${python: perms[user]['name']}</h6>
                        <ul>
                          <tal:repeat tal:repeat="other_permissions python: sorted(perms[user]['permissions'])">
                            <li tal:condition="python: other_permissions in ['Delete objects', 'Copy or Move', 'Change permissions', 'Add Folders', 'Define permissions']">
                            ${other_permissions}
                            </li>
                          </tal:repeat>
                        </ul>
                        </div>
                      </div>
                    </tal:block>
                  </td>

                </tal:define>
              </tr>
            </tal:loop>
          </tbody>
        </table>


      </tal:block>

    </metal:block>
  </metal:content-core>
</body>
</html>
